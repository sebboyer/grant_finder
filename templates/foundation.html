<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Foundation Profile - Grant Finder</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="/style.css">
    <script src="https://d3js.org/d3.v7.min.js"></script>
    <script src="https://d3js.org/topojson.v3.min.js"></script>
</head>
<body>
    <header>
        <div class="container">
            <div class="header-nav">
                <a href="/" class="back-link">‚Üê Back to Search</a>
            </div>
            <div id="foundation-header">
                        <h1 id="foundation-name">Loading...</h1>
                <p class="foundation-location-ein" id="location-ein">Loading...</p>
                <p class="foundation-summary" id="foundation-summary">Loading foundation information...</p>
                
                <!-- Action Buttons -->
                <div class="header-actions">
                    <button class="action-btn" onclick="shareFoundation()" title="Share this profile">
                        <span>üì§</span> Share
                    </button>
                    <button class="action-btn" onclick="saveFoundation()" title="Save for later">
                        <span>üíæ</span> Save
                    </button>
                </div>
            </div>
        </div>
    </header>

    <main>
        <div class="container">
            <div id="profile-loading" class="loading-indicator">
                <div class="spinner"></div>
                <p>Loading foundation profile...</p>
            </div>

            <div id="profile-content" style="display: none;">
                <!-- Tab Navigation -->
                <nav class="tab-navigation">
                    <button class="tab-btn active" data-tab="overview">Overview</button>
                    <button class="tab-btn" data-tab="financials">Financials</button>
                    <button class="tab-btn" data-tab="grants">Grants</button>
                    <button class="tab-btn" data-tab="people">People</button>
                </nav>

                <!-- Tab: Overview -->
                <div id="tab-overview" class="tab-content active">
                    <!-- About Section -->
                    <section class="profile-section" id="about-section" style="display: none;">
                        <h2 class="section-title">About FOUNDATION NAME</h2>
                        <div class="about-content-box">
                            <p id="about-description" class="about-description"></p>
                            <div class="about-meta-grid">
                                <div class="meta-item" id="focus-areas-meta" style="display: none;">
                                    <div class="meta-label">Focus areas</div>
                                    <div class="meta-value" id="focus-areas-display"></div>
                            </div>
                                <div class="meta-item" id="geo-focus-meta" style="display: none;">
                                    <div class="meta-label">Geographic focus</div>
                                    <div class="meta-value" id="geo-focus-display"></div>
                                </div>
                        </div>
                    </div>
                </section>

                    <!-- Key Statistics -->
                    <section class="profile-section">
                        <h2 class="section-title">Key statistics</h2>
                        <div class="key-stats-grid">
                            <div class="key-stat-item">
                                <div class="key-stat-label">Total Assets</div>
                                <div class="key-stat-value" id="overview-total-assets">-</div>
                                </div>
                            <div class="key-stat-item">
                                <div class="key-stat-label">Total Awarded This Year</div>
                                <div class="key-stat-value" id="overview-total-awarded">-</div>
                            </div>
                            <div class="key-stat-item">
                                <div class="key-stat-label">Average Grant Size</div>
                                <div class="key-stat-value" id="overview-avg-grant">-</div>
                                </div>
                            <div class="key-stat-item">
                                <div class="key-stat-label">Total Grants (Previous Year)</div>
                                <div class="key-stat-value" id="overview-total-grants">-</div>
                            </div>
                            <div class="key-stat-item">
                                <div class="key-stat-label">Open to New Applicants</div>
                                <div class="key-stat-value unknown" id="overview-new-applicants">Unknown</div>
                                </div>
                            <div class="key-stat-item">
                                <div class="key-stat-label">% New Applicants Funded</div>
                                <div class="key-stat-value unknown" id="overview-new-funded">N/A</div>
                            </div>
                        </div>
                    </section>

                    <!-- Contact Information -->
                    <section class="profile-section" id="contact-overview-section" style="display: none;">
                        <h2 class="section-title">Contact information</h2>
                        <div class="contact-overview-grid">
                            <div class="contact-overview-item" id="contact-address-overview" style="display: none;">
                                <div class="contact-overview-icon">üìç</div>
                                <div>
                                    <div class="contact-overview-label">Address</div>
                                    <div class="contact-overview-value" id="address-overview"></div>
                            </div>
                            </div>
                            <div class="contact-overview-item" id="contact-website-overview" style="display: none;">
                                <div class="contact-overview-icon">üåê</div>
                                <div>
                                    <div class="contact-overview-label">Website</div>
                                    <a href="" id="website-overview" target="_blank" rel="noopener noreferrer" class="contact-overview-link"></a>
                            </div>
                            </div>
                            <div class="contact-overview-item" id="contact-phone-overview" style="display: none;">
                                <div class="contact-overview-icon">üìû</div>
                                <div>
                                    <div class="contact-overview-label">Phone</div>
                                    <a href="" id="phone-overview" class="contact-overview-link"></a>
                            </div>
                            </div>
                        </div>
                    </section>
                </div>

                <!-- Tab: Financials -->
                <div id="tab-financials" class="tab-content">
                    <section class="profile-section">
                        <h2 class="section-title">Financial Overview</h2>
                        <div class="financial-summary-cards">
                            <div class="financial-summary-card" id="fin-assets-card" style="display: none;">
                                <div class="fin-card-label">Total assets</div>
                                <div class="fin-card-value" id="fin-total-assets">-</div>
                                <div class="fin-card-note" id="fin-assets-note">in 2024, compared to previous year</div>
                            </div>
                            <div class="financial-summary-card" id="fin-grants-card" style="display: none;">
                                <div class="fin-card-label">Annual grants</div>
                                <div class="fin-card-value" id="fin-annual-grants">-</div>
                                <div class="fin-card-note" id="fin-grants-note">grants awarded</div>
                            </div>
                            <div class="financial-summary-card" id="fin-expenses-card" style="display: none;">
                                <div class="fin-card-label">Program expenses</div>
                                <div class="fin-card-value" id="fin-program-expenses">-</div>
                                <div class="fin-card-note" id="fin-expenses-note">Of total expenses go to programs</div>
                        </div>
                    </div>
                </section>

                    <section class="profile-section" id="detailed-financials-section" style="display: none;">
                        <h2 class="section-title">Detailed Financials</h2>
                        <div class="financial-details-grid">
                            <div class="fin-detail-item" id="fin-revenue-item" style="display: none;">
                                <div class="fin-detail-label">Total Revenue</div>
                                <div class="fin-detail-value" id="fin-revenue">-</div>
                            </div>
                            <div class="fin-detail-item" id="fin-total-expenses-item" style="display: none;">
                                <div class="fin-detail-label">Total Expenses</div>
                                <div class="fin-detail-value" id="fin-total-expenses">-</div>
                        </div>
                            <div class="fin-detail-item" id="fin-distributions-item" style="display: none;">
                                <div class="fin-detail-label">Distributions Paid</div>
                                <div class="fin-detail-value" id="fin-distributions">-</div>
                            </div>
                            <div class="fin-detail-item" id="fin-investment-item" style="display: none;">
                                <div class="fin-detail-label">Investment Income</div>
                                <div class="fin-detail-value" id="fin-investment">-</div>
                        </div>
                            <div class="fin-detail-item" id="fin-fmv-item" style="display: none;">
                                <div class="fin-detail-label">Fair Market Value</div>
                                <div class="fin-detail-value" id="fin-fmv">-</div>
                            </div>
                        </div>
                    </section>
                            </div>

                <!-- Tab: Grants -->
                <div id="tab-grants" class="tab-content">
                    <!-- Grant Statistics -->
                    <section class="profile-section">
                        <div class="grants-stats-bar">
                            <div class="grant-stat-item">
                                <div class="grant-stat-value" id="grants-total-count">-</div>
                                <div class="grant-stat-label">Total Grants</div>
                            </div>
                            <div class="grant-stat-item">
                                <div class="grant-stat-value" id="grants-total-amount">-</div>
                                <div class="grant-stat-label">Total Awarded</div>
                            </div>
                            <div class="grant-stat-item">
                                <div class="grant-stat-value" id="grants-median">-</div>
                                <div class="grant-stat-label">Median Grant</div>
                            </div>
                            <div class="grant-stat-item">
                                <div class="grant-stat-value" id="grants-average">-</div>
                                <div class="grant-stat-label">Average Grant</div>
                        </div>
                    </div>
                </section>

                    <!-- Grant Range -->
                <section class="profile-section">
                    <h2 class="section-title">Grant Range</h2>
                    <div class="grant-range-card">
                        <div class="range-info">
                            <div class="range-endpoints">
                                <div class="range-item">
                                    <span class="range-label">Minimum</span>
                                    <span class="range-value min" id="range-min">$0</span>
                                </div>
                                <div class="range-item">
                                    <span class="range-label">Maximum</span>
                                    <span class="range-value max" id="range-max">$0</span>
                                </div>
                            </div>
                            <div class="range-bar-container">
                                <div class="range-markers">
                                    <div class="range-marker">
                                        <div class="range-marker-label" id="marker-min">$0</div>
                                        <div class="range-marker-dot"></div>
                                    </div>
                                    <div class="range-marker middle">
                                        <div class="range-marker-label" id="marker-median">$0</div>
                                        <div class="range-marker-dot"></div>
                                    </div>
                                    <div class="range-marker">
                                        <div class="range-marker-label" id="marker-max">$0</div>
                                        <div class="range-marker-dot"></div>
                                    </div>
                                </div>
                                <div class="range-bar-track">
                                    <div class="range-bar"></div>
                                </div>
                            </div>
                        </div>
                        <div class="range-detail">
                            <span class="detail-badge">Median: <strong id="range-median-badge">$0</strong></span>
                        </div>
                    </div>
                </section>

                    <!-- Grant Awards Table -->
                <section class="profile-section">
                        <h2 class="section-title">Grant awards</h2>
                        <div class="table-card">
                            <div class="table-controls">
                                <input type="text" id="grant-search" class="table-search" placeholder="Search grants...">
                                <select id="grant-sort" class="table-sort">
                                    <option value="amount-desc">Amount (High to Low)</option>
                                    <option value="amount-asc">Amount (Low to High)</option>
                                    <option value="name-asc">Recipient (A-Z)</option>
                                    <option value="year-desc">Year (Newest)</option>
                                </select>
                            </div>
                            <div class="table-wrapper">
                                <table class="grants-table">
                                    <thead>
                                        <tr>
                                            <th>Amount</th>
                                            <th>Name</th>
                                            <th>Purpose</th>
                                            <th>Location</th>
                                            <th>Year</th>
                                        </tr>
                                    </thead>
                                    <tbody id="grants-table-body">
                                        <!-- Will be populated by JavaScript -->
                                    </tbody>
                                </table>
                            </div>
                            <div class="table-pagination">
                                <button id="load-more-grants" class="btn-load-more">Load More Grants</button>
                                <div id="grants-count-display" class="grants-count"></div>
                            </div>
                        </div>
                    </section>

                    <!-- Geographic Distribution -->
                    <section class="profile-section">
                        <h2 class="section-title">Geographic Distribution</h2>
                        <details class="collapsible-section">
                            <summary class="collapsible-header">View Interactive Map</summary>
                    <div class="map-card">
                        <div id="us-map-container">
                            <svg id="us-map" viewBox="0 0 960 600"></svg>
                        </div>
                        <div id="map-tooltip" class="map-tooltip"></div>
                        <div class="map-legend">
                            <div class="legend-title">Number of Grants</div>
                            <div class="legend-scale">
                                <div class="legend-gradient"></div>
                                <div class="legend-labels">
                                    <span>0</span>
                                    <span id="legend-max">-</span>
                                </div>
                            </div>
                        </div>
                    </div>
                        </details>
                </section>
                </div>

                <!-- Tab: People -->
                <div id="tab-people" class="tab-content">
                    <section class="profile-section" id="people-section">
                        <h2 class="section-title">Leadership & staff</h2>
                        <p class="section-subtitle">Compensation data from most recent available 990 forms</p>
                    <div class="table-card">
                            <table class="people-table">
                            <thead>
                                <tr>
                                        <th>Name</th>
                                        <th>Title</th>
                                        <th>Compensation</th>
                                        <th>Year</th>
                                </tr>
                            </thead>
                                <tbody id="people-table-body">
                                <!-- Will be populated by JavaScript -->
                            </tbody>
                        </table>
                    </div>
                </section>
                        </div>
            </div>
        </div>
    </main>

    <footer>
        <div class="container">
            <p>Financial data sourced from IRS 990 forms via ProPublica Nonprofit Explorer | Grant Finder &copy; 2025</p>
        </div>
    </footer>

    <script>
        const foundationEIN = {{ ein }};
        let foundationData = null;
        let allGrants = [];
        let displayedGrantsCount = 20;
        const GRANTS_PER_PAGE = 20;

        // Tab Switching
        function initTabs() {
            const tabBtns = document.querySelectorAll('.tab-btn');
            const tabContents = document.querySelectorAll('.tab-content');

            tabBtns.forEach(btn => {
                btn.addEventListener('click', () => {
                    const targetTab = btn.dataset.tab;
                    
                    // Update URL hash
                    window.location.hash = targetTab;
                    
                    // Update active states
                    tabBtns.forEach(b => b.classList.remove('active'));
                    tabContents.forEach(c => c.classList.remove('active'));
                    
                    btn.classList.add('active');
                    document.getElementById(`tab-${targetTab}`).classList.add('active');
                    
                    // Load map when grants tab is opened
                    if (targetTab === 'grants' && foundationData && !window.mapLoaded) {
                        displayUSMap(foundationData.states_data);
                        window.mapLoaded = true;
                    }
                });
            });

            // Handle hash navigation
            if (window.location.hash) {
                const hash = window.location.hash.substring(1);
                const targetBtn = document.querySelector(`[data-tab="${hash}"]`);
                if (targetBtn) {
                    targetBtn.click();
                }
            }
        }

        // Action button handlers
        function shareFoundation() {
            if (navigator.share && foundationData) {
                navigator.share({
                    title: foundationData.foundation_name,
                    text: `Check out ${foundationData.foundation_name} on Grant Finder`,
                    url: window.location.href
                }).catch(err => console.log('Error sharing:', err));
            } else {
                // Fallback: copy to clipboard
                navigator.clipboard.writeText(window.location.href);
                alert('Link copied to clipboard!');
            }
        }

        function saveFoundation() {
            alert('Save feature coming soon! This will allow you to bookmark foundations for later review.');
        }

        // Load foundation data
        async function loadFoundationData() {
            try {
                const response = await fetch(`/api/foundation/${foundationEIN}/stats`);
                if (!response.ok) {
                    throw new Error('Foundation not found');
                }
                foundationData = await response.json();
                allGrants = [...foundationData.top_grants, ...foundationData.recent_grants];
                displayFoundationData();
            } catch (error) {
                console.error('Error loading foundation data:', error);
                document.getElementById('profile-loading').innerHTML = `
                    <div class="empty-state">
                        <div class="empty-state-icon">‚ö†Ô∏è</div>
                        <h3>Foundation Not Found</h3>
                        <p>The foundation you're looking for could not be found.</p>
                        <a href="/" class="btn-primary" style="margin-top: 20px; display: inline-block;">Back to Search</a>
                    </div>
                `;
            }
        }

        function displayFoundationData() {
            // Hide loading, show content
            document.getElementById('profile-loading').style.display = 'none';
            document.getElementById('profile-content').style.display = 'block';

            // Update header
            document.getElementById('foundation-name').textContent = foundationData.foundation_name;
            updateLocationEIN();
            generateSummary();

            // Populate all tabs
            populateOverviewTab();
            populateFinancialsTab();
            populateGrantsTab();
            populatePeopleTab();

            // Initialize tabs
            initTabs();
        }

        function updateLocationEIN() {
            const location = [foundationData.foundation_city, foundationData.foundation_state].filter(Boolean).join(', ');
            const ein = foundationData.foundation_ein || foundationEIN;
            document.getElementById('location-ein').textContent = location ? `${location} | EIN: ${ein}` : `EIN: ${ein}`;
        }

        function generateSummary() {
            const parts = [];
            
            // Foundation name and type
            const name = foundationData.foundation_name;
            const type = foundationData.is_private_operating_foundation ? 
                'operating foundation' : 'grant-making foundation';
            
            // Location
            const location = [foundationData.foundation_city, foundationData.foundation_state]
                .filter(Boolean).join(', ');
            
            // Financial status
            let financialStatus = '';
            if (foundationData.total_assets && foundationData.total_expenses) {
                if (foundationData.total_expenses > foundationData.total_assets * 0.1) {
                    financialStatus = 'with active grant-making operations';
            } else {
                    financialStatus = 'with stable financial operations';
                }
            }
            
            // Focus areas
            const focusAreas = foundationData.top_purposes && foundationData.top_purposes.length > 0 ?
                foundationData.top_purposes[0].toLowerCase() : 'various charitable purposes';
            
            // Geographic reach
            const stateCount = foundationData.states_data ? foundationData.states_data.length : 0;
            const geoReach = stateCount > 5 ? 
                `operations across ${stateCount} states` : 
                stateCount > 1 ? `${stateCount} states` : 
                foundationData.primary_state || 'the region';
            
            // Leadership
            const officers = foundationData.officers || [];
            const volunteerOfficers = officers.filter(o => !o.total_compensation || o.total_compensation === 0);
            const leadershipInfo = volunteerOfficers.length === officers.length && officers.length > 0 ?
                'led by volunteer executives' : 
                officers.length > 0 ? `led by ${officers.length} board members` : '';
            
            // Construct summary
            const summary = `${name} is a ${type}${location ? ` based in ${location}` : ''}${focusAreas ? `, focusing on ${focusAreas}` : ''}${financialStatus ? `, ${financialStatus}` : ''}${geoReach ? `, with ${geoReach}` : ''}${leadershipInfo ? `, ${leadershipInfo}` : ''}.`;
            
            document.getElementById('foundation-summary').textContent = summary;
        }

        function populateOverviewTab() {
            // About section
            let hasAbout = false;
            const aboutDescription = [];
            
            if (foundationData.mission && foundationData.mission.trim()) {
                aboutDescription.push(foundationData.mission);
                hasAbout = true;
            }
            
            if (foundationData.formation_year) {
                const year = parseInt(foundationData.formation_year);
                const age = new Date().getFullYear() - year;
                aboutDescription.push(`Founded in ${year} (${age} years ago).`);
                hasAbout = true;
            }
            
            if (foundationData.is_private_operating_foundation !== undefined) {
                const type = foundationData.is_private_operating_foundation ? 
                    'Private Operating Foundation' : 'Private Grant-Making Foundation';
                aboutDescription.push(`Type: ${type}.`);
                hasAbout = true;
            }
            
            if (foundationData.legal_domicile_state) {
                aboutDescription.push(`Legal domicile: ${foundationData.legal_domicile_state}.`);
                hasAbout = true;
            }
            
            if (hasAbout) {
                document.getElementById('about-description').textContent = aboutDescription.join(' ');
                document.querySelector('#about-section .section-title').textContent = `About ${foundationData.foundation_name}`;
                document.getElementById('about-section').style.display = 'block';
                
                // Focus areas
                if (foundationData.top_purposes && foundationData.top_purposes.length > 0) {
                    document.getElementById('focus-areas-display').textContent = foundationData.top_purposes.join(', ');
                    document.getElementById('focus-areas-meta').style.display = 'block';
                }
                
                // Geographic focus
                if (foundationData.states_data && foundationData.states_data.length > 0) {
                    const states = foundationData.states_data.slice(0, 10).map(s => s.state).join(', ');
                    const moreCount = foundationData.states_data.length - 10;
                    document.getElementById('geo-focus-display').textContent = states + (moreCount > 0 ? ` and ${moreCount} more` : '');
                    document.getElementById('geo-focus-meta').style.display = 'block';
                }
            }
            
            // Key Statistics
            if (foundationData.total_assets && foundationData.total_assets > 0) {
                document.getElementById('overview-total-assets').textContent = `$${formatLargeNumber(foundationData.total_assets)}`;
            }
            
            if (foundationData.total_distributions_paid && foundationData.total_distributions_paid > 0) {
                document.getElementById('overview-total-awarded').textContent = `$${formatLargeNumber(foundationData.total_distributions_paid)}`;
            } else if (foundationData.total_amount) {
                document.getElementById('overview-total-awarded').textContent = `$${formatLargeNumber(foundationData.total_amount)}`;
            }
            
            if (foundationData.avg_grant) {
                document.getElementById('overview-avg-grant').textContent = `$${formatNumber(foundationData.avg_grant)}`;
            }
            
            if (foundationData.grant_count) {
                document.getElementById('overview-total-grants').textContent = foundationData.grant_count.toLocaleString();
            }
            
            // Contact Information
            let hasContact = false;
            
            if (foundationData.foundation_address || foundationData.foundation_city) {
                const parts = [];
                if (foundationData.foundation_address) parts.push(foundationData.foundation_address);
                if (foundationData.foundation_address2) parts.push(foundationData.foundation_address2);
                
                const cityState = [foundationData.foundation_city, foundationData.foundation_state].filter(Boolean).join(', ');
                if (cityState) parts.push(cityState);
                if (foundationData.foundation_zip) parts.push(foundationData.foundation_zip);
                
                if (parts.length > 0) {
                    document.getElementById('address-overview').textContent = parts.join(', ');
                    document.getElementById('contact-address-overview').style.display = 'flex';
                    hasContact = true;
                }
            }
            
            if (foundationData.foundation_website) {
                const url = formatWebsiteURL(foundationData.foundation_website);
                document.getElementById('website-overview').href = url;
                document.getElementById('website-overview').textContent = foundationData.foundation_website;
                document.getElementById('contact-website-overview').style.display = 'flex';
                hasContact = true;
            }
            
            if (foundationData.foundation_phone) {
                const formatted = formatPhoneNumber(foundationData.foundation_phone);
                document.getElementById('phone-overview').href = `tel:${foundationData.foundation_phone}`;
                document.getElementById('phone-overview').textContent = formatted;
                document.getElementById('contact-phone-overview').style.display = 'flex';
                hasContact = true;
            }
            
            if (hasContact) {
                document.getElementById('contact-overview-section').style.display = 'block';
            }
        }

        function populateFinancialsTab() {
            let hasFinancialSummary = false;
            let hasDetailedFinancials = false;
            
            // Financial Summary Cards
            if (foundationData.total_assets && foundationData.total_assets > 0) {
                document.getElementById('fin-total-assets').textContent = `$${formatLargeNumber(foundationData.total_assets)}`;
                document.getElementById('fin-assets-card').style.display = 'block';
                hasFinancialSummary = true;
            }
            
            if (foundationData.total_distributions_paid && foundationData.total_distributions_paid > 0) {
                document.getElementById('fin-annual-grants').textContent = `$${formatLargeNumber(foundationData.total_distributions_paid)}`;
                document.getElementById('fin-grants-note').textContent = `${foundationData.grant_count || 0} grants awarded`;
                document.getElementById('fin-grants-card').style.display = 'block';
                hasFinancialSummary = true;
            } else if (foundationData.total_amount) {
                document.getElementById('fin-annual-grants').textContent = `$${formatLargeNumber(foundationData.total_amount)}`;
                document.getElementById('fin-grants-note').textContent = `${foundationData.grant_count || 0} grants awarded`;
                document.getElementById('fin-grants-card').style.display = 'block';
                hasFinancialSummary = true;
            }
            
            if (foundationData.total_expenses && foundationData.total_expenses > 0) {
                document.getElementById('fin-program-expenses').textContent = `$${formatLargeNumber(foundationData.total_expenses)}`;
                // Calculate percentage if we have distributions
                if (foundationData.total_distributions_paid) {
                    const pct = Math.round((foundationData.total_distributions_paid / foundationData.total_expenses) * 100);
                    document.getElementById('fin-expenses-note').textContent = `${pct}% of total expenses go to programs`;
                }
                document.getElementById('fin-expenses-card').style.display = 'block';
                hasFinancialSummary = true;
            }
            
            // Detailed Financials
            if (foundationData.total_revenue && foundationData.total_revenue > 0) {
                document.getElementById('fin-revenue').textContent = `$${formatLargeNumber(foundationData.total_revenue)}`;
                document.getElementById('fin-revenue-item').style.display = 'block';
                hasDetailedFinancials = true;
            }
            
            if (foundationData.total_expenses && foundationData.total_expenses > 0) {
                document.getElementById('fin-total-expenses').textContent = `$${formatLargeNumber(foundationData.total_expenses)}`;
                document.getElementById('fin-total-expenses-item').style.display = 'block';
                hasDetailedFinancials = true;
            }
            
            if (foundationData.total_distributions_paid && foundationData.total_distributions_paid > 0) {
                document.getElementById('fin-distributions').textContent = `$${formatLargeNumber(foundationData.total_distributions_paid)}`;
                document.getElementById('fin-distributions-item').style.display = 'block';
                hasDetailedFinancials = true;
            }
            
            if (foundationData.investment_income && foundationData.investment_income > 0) {
                document.getElementById('fin-investment').textContent = `$${formatLargeNumber(foundationData.investment_income)}`;
                document.getElementById('fin-investment-item').style.display = 'block';
                hasDetailedFinancials = true;
            }
            
            if (foundationData.fair_market_value && foundationData.fair_market_value > 0) {
                document.getElementById('fin-fmv').textContent = `$${formatLargeNumber(foundationData.fair_market_value)}`;
                document.getElementById('fin-fmv-item').style.display = 'block';
                hasDetailedFinancials = true;
            }
            
            if (hasDetailedFinancials) {
                document.getElementById('detailed-financials-section').style.display = 'block';
            }
        }

        function populateGrantsTab() {
            // Grant Statistics
            if (foundationData.grant_count) {
                document.getElementById('grants-total-count').textContent = foundationData.grant_count.toLocaleString();
            }
            
            if (foundationData.total_amount) {
                document.getElementById('grants-total-amount').textContent = `$${formatLargeNumber(foundationData.total_amount)}`;
            }
            
            if (foundationData.median_grant) {
                document.getElementById('grants-median').textContent = `$${formatNumber(foundationData.median_grant)}`;
            }
            
            if (foundationData.avg_grant) {
                document.getElementById('grants-average').textContent = `$${formatNumber(foundationData.avg_grant)}`;
            }
            
            // Grant Range
            document.getElementById('range-min').textContent = `$${formatNumber(foundationData.min_grant)}`;
            document.getElementById('range-max').textContent = `$${formatNumber(foundationData.max_grant)}`;
            document.getElementById('marker-min').textContent = `$${formatNumber(foundationData.min_grant)}`;
            document.getElementById('marker-median').textContent = `$${formatNumber(foundationData.median_grant)}`;
            document.getElementById('marker-max').textContent = `$${formatNumber(foundationData.max_grant)}`;
            document.getElementById('range-median-badge').textContent = `$${formatNumber(foundationData.median_grant)}`;
            
            // Grants Table
            displayGrantsTable();
            
            // Setup search and sort
            document.getElementById('grant-search').addEventListener('input', filterGrants);
            document.getElementById('grant-sort').addEventListener('change', sortGrants);
            document.getElementById('load-more-grants').addEventListener('click', loadMoreGrants);
        }

        function displayGrantsTable() {
            const tbody = document.getElementById('grants-table-body');
            tbody.innerHTML = '';
            
            const grantsToShow = allGrants.slice(0, displayedGrantsCount);
            
            grantsToShow.forEach(grant => {
                const row = document.createElement('tr');
                const location = [grant.recipient_city, grant.recipient_state].filter(Boolean).join(', ') || '-';
                const year = grant.tax_period ? new Date(grant.tax_period).getFullYear() : '-';
                
                row.innerHTML = `
                    <td class="grant-amount-cell">$${grant.grant_amount.toLocaleString()}</td>
                    <td><strong>${escapeHtml(grant.recipient_name)}</strong></td>
                    <td>${escapeHtml(grant.grant_purpose || 'No purpose specified')}</td>
                    <td>${escapeHtml(location)}</td>
                    <td>${year}</td>
                `;
                tbody.appendChild(row);
            });
            
            // Update count display
            document.getElementById('grants-count-display').textContent = 
                `Showing ${grantsToShow.length} of ${allGrants.length} grants`;
            
            // Show/hide load more button
            const loadMoreBtn = document.getElementById('load-more-grants');
            if (displayedGrantsCount >= allGrants.length) {
                loadMoreBtn.style.display = 'none';
                } else {
                loadMoreBtn.style.display = 'block';
            }
        }

        function loadMoreGrants() {
            displayedGrantsCount += GRANTS_PER_PAGE;
            displayGrantsTable();
        }

        function filterGrants() {
            const searchTerm = document.getElementById('grant-search').value.toLowerCase();
            if (!searchTerm) {
                displayedGrantsCount = GRANTS_PER_PAGE;
                displayGrantsTable();
                return;
            }
            
            const filtered = allGrants.filter(grant => {
                return grant.recipient_name.toLowerCase().includes(searchTerm) ||
                       (grant.grant_purpose && grant.grant_purpose.toLowerCase().includes(searchTerm)) ||
                       (grant.recipient_city && grant.recipient_city.toLowerCase().includes(searchTerm)) ||
                       (grant.recipient_state && grant.recipient_state.toLowerCase().includes(searchTerm));
            });
            
            const tbody = document.getElementById('grants-table-body');
            tbody.innerHTML = '';
            
            filtered.forEach(grant => {
                const row = document.createElement('tr');
                const location = [grant.recipient_city, grant.recipient_state].filter(Boolean).join(', ') || '-';
                const year = grant.tax_period ? new Date(grant.tax_period).getFullYear() : '-';
                
                row.innerHTML = `
                    <td class="grant-amount-cell">$${grant.grant_amount.toLocaleString()}</td>
                    <td><strong>${escapeHtml(grant.recipient_name)}</strong></td>
                    <td>${escapeHtml(grant.grant_purpose || 'No purpose specified')}</td>
                    <td>${escapeHtml(location)}</td>
                    <td>${year}</td>
                `;
                tbody.appendChild(row);
            });
            
            document.getElementById('grants-count-display').textContent = 
                `Showing ${filtered.length} of ${allGrants.length} grants`;
            document.getElementById('load-more-grants').style.display = 'none';
        }

        function sortGrants() {
            const sortBy = document.getElementById('grant-sort').value;
            
            switch(sortBy) {
                case 'amount-desc':
                    allGrants.sort((a, b) => b.grant_amount - a.grant_amount);
                    break;
                case 'amount-asc':
                    allGrants.sort((a, b) => a.grant_amount - b.grant_amount);
                    break;
                case 'name-asc':
                    allGrants.sort((a, b) => a.recipient_name.localeCompare(b.recipient_name));
                    break;
                case 'year-desc':
                    allGrants.sort((a, b) => {
                        const yearA = a.tax_period ? new Date(a.tax_period).getFullYear() : 0;
                        const yearB = b.tax_period ? new Date(b.tax_period).getFullYear() : 0;
                        return yearB - yearA;
                    });
                    break;
            }
            
            displayedGrantsCount = GRANTS_PER_PAGE;
            displayGrantsTable();
        }

        function populatePeopleTab() {
            const officers = foundationData.officers || [];
            
            if (officers.length === 0) {
                document.getElementById('people-table-body').innerHTML = `
                    <tr><td colspan="4" style="text-align: center; padding: 40px; color: var(--text-medium);">
                        No officer information available
                    </td></tr>
                `;
                return;
            }
            
            const tbody = document.getElementById('people-table-body');
            tbody.innerHTML = '';
            
            officers.forEach(officer => {
                const row = document.createElement('tr');
                const compensation = officer.total_compensation && officer.total_compensation > 0 ?
                    `$${officer.total_compensation.toLocaleString()}` : 
                    '<span class="volunteer-badge-inline">$0 (Volunteer)</span>';
                
                row.innerHTML = `
                    <td><strong>${escapeHtml(officer.name || 'Unknown')}</strong></td>
                    <td>${escapeHtml(officer.title || 'Board Member')}</td>
                    <td>${compensation}</td>
                    <td>Recent</td>
                `;
                tbody.appendChild(row);
            });
        }

        async function displayUSMap(statesData) {
            // Create a map of state codes to data
            const stateMap = {};
            statesData.forEach(state => {
                stateMap[state.state] = state;
            });

            const maxGrants = Math.max(...statesData.map(s => s.grant_count), 1);
            document.getElementById('legend-max').textContent = maxGrants;

            // Color scale with nicer colors
            const colorScale = d3.scaleSequential()
                .domain([0, maxGrants])
                .interpolator(t => {
                    if (t === 0) return '#e8eaed';
                    if (t < 0.5) {
                        return d3.interpolate('#09cfaf', '#5555e7')(t * 2);
                    } else {
                        return d3.interpolate('#5555e7', '#ffb424')((t - 0.5) * 2);
                    }
                });

            const svg = d3.select('#us-map');
            const tooltip = d3.select('#map-tooltip');

            svg.selectAll('*').remove();

            const us = await d3.json('https://cdn.jsdelivr.net/npm/us-atlas@3/states-10m.json');
            const states = topojson.feature(us, us.objects.states);

            const width = 960;
            const height = 600;
            
            const projection = d3.geoAlbersUsa()
                .scale(1200)
                .translate([width / 2, height / 2]);

            const path = d3.geoPath().projection(projection);

            svg.attr('viewBox', `0 0 ${width} ${height}`)
               .attr('preserveAspectRatio', 'xMidYMid meet');

            const stateIdToAbbr = {
                '01': 'AL', '02': 'AK', '04': 'AZ', '05': 'AR', '06': 'CA', '08': 'CO', '09': 'CT', '10': 'DE',
                '11': 'DC', '12': 'FL', '13': 'GA', '15': 'HI', '16': 'ID', '17': 'IL', '18': 'IN', '19': 'IA',
                '20': 'KS', '21': 'KY', '22': 'LA', '23': 'ME', '24': 'MD', '25': 'MA', '26': 'MI', '27': 'MN',
                '28': 'MS', '29': 'MO', '30': 'MT', '31': 'NE', '32': 'NV', '33': 'NH', '34': 'NJ', '35': 'NM',
                '36': 'NY', '37': 'NC', '38': 'ND', '39': 'OH', '40': 'OK', '41': 'OR', '42': 'PA', '44': 'RI',
                '45': 'SC', '46': 'SD', '47': 'TN', '48': 'TX', '49': 'UT', '50': 'VT', '51': 'VA', '53': 'WA',
                '54': 'WV', '55': 'WI', '56': 'WY'
            };

            svg.append('g')
                .selectAll('path')
                .data(states.features)
                .join('path')
                .attr('d', path)
                .attr('class', 'state')
                .attr('fill', d => {
                    const stateId = d.id.toString().padStart(2, '0');
                    const stateAbbr = stateIdToAbbr[stateId];
                    const data = stateMap[stateAbbr];
                    return data ? colorScale(data.grant_count) : '#f5f5f5';
                })
                .attr('stroke', '#ffffff')
                .attr('stroke-width', 1.5)
                .attr('stroke-linejoin', 'round')
                .style('cursor', d => {
                    const stateId = d.id.toString().padStart(2, '0');
                    const stateAbbr = stateIdToAbbr[stateId];
                    return stateMap[stateAbbr] ? 'pointer' : 'default';
                })
                .on('mouseover', function(event, d) {
                    const stateId = d.id.toString().padStart(2, '0');
                    const stateAbbr = stateIdToAbbr[stateId];
                    const data = stateMap[stateAbbr];
                    
                    if (data) {
                        d3.select(this)
                            .attr('stroke', '#0f0e5b')
                            .attr('stroke-width', 2.5)
                            .raise();
                        
                        tooltip.style('display', 'block')
                            .style('left', (event.pageX + 10) + 'px')
                            .style('top', (event.pageY - 10) + 'px')
                            .html(`
                                <div style="font-weight: 700; margin-bottom: 4px; font-size: 14px;">${stateAbbr}</div>
                                <div>Grants: <strong>${data.grant_count.toLocaleString()}</strong></div>
                                <div>Total: <strong>$${formatLargeNumber(data.total_amount)}</strong></div>
                                <div>Avg: <strong>$${formatNumber(data.avg_grant)}</strong></div>
                                <div>Median: <strong>$${formatNumber(data.median_grant)}</strong></div>
                            `);
                    }
                })
                .on('mouseout', function(event, d) {
                    d3.select(this)
                        .attr('stroke', '#ffffff')
                        .attr('stroke-width', 1.5);
                    tooltip.style('display', 'none');
                });

            const labelGroup = svg.append('g')
                .attr('class', 'state-labels');

            states.features.forEach(feature => {
                const stateId = feature.id.toString().padStart(2, '0');
                const stateAbbr = stateIdToAbbr[stateId];
                const data = stateMap[stateAbbr];
                
                if (data && data.grant_count > 0) {
                    const centroid = path.centroid(feature);
                    if (!isNaN(centroid[0]) && !isNaN(centroid[1])) {
                        labelGroup.append('text')
                            .attr('x', centroid[0])
                            .attr('y', centroid[1] - 5)
                            .attr('text-anchor', 'middle')
                            .attr('font-size', '11px')
                            .attr('font-weight', '700')
                            .attr('fill', '#ffffff')
                            .attr('pointer-events', 'none')
                            .style('text-shadow', '0 1px 3px rgba(0, 0, 0, 0.3)')
                            .text(stateAbbr);
                        
                        labelGroup.append('text')
                            .attr('x', centroid[0])
                            .attr('y', centroid[1] + 8)
                            .attr('text-anchor', 'middle')
                            .attr('font-size', '10px')
                            .attr('font-weight', '600')
                            .attr('fill', 'rgba(255, 255, 255, 0.95)')
                            .attr('pointer-events', 'none')
                            .style('text-shadow', '0 1px 2px rgba(0, 0, 0, 0.3)')
                            .text(data.grant_count);
                    }
                }
            });
        }

        // Utility functions
        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }

        function formatLargeNumber(num) {
            if (num >= 1000000) {
                return (num / 1000000).toFixed(1) + 'M';
            } else if (num >= 1000) {
                return (num / 1000).toFixed(1) + 'K';
            }
            return num.toLocaleString();
        }

        function formatNumber(num) {
            if (num >= 1000000) {
                return (num / 1000000).toFixed(1) + 'M';
            } else if (num >= 1000) {
                return (num / 1000).toFixed(0) + 'K';
            }
            return num.toLocaleString();
        }

        function formatWebsiteURL(url) {
            if (!url) return '';
            url = url.trim().toLowerCase();
            if (!url.startsWith('http://') && !url.startsWith('https://')) {
                return 'https://' + url;
            }
            return url;
        }

        function formatPhoneNumber(phone) {
            if (!phone) return '';
            const cleaned = phone.toString().replace(/\D/g, '');
            if (cleaned.length === 10) {
                return `(${cleaned.slice(0,3)}) ${cleaned.slice(3,6)}-${cleaned.slice(6)}`;
            }
            return phone;
        }

        // Initialize on page load
        document.addEventListener('DOMContentLoaded', loadFoundationData);
    </script>
</body>
</html>
